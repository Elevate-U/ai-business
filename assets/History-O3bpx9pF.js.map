{"version":3,"file":"History-O3bpx9pF.js","sources":["../../src/pages/History.jsx"],"sourcesContent":["import { h } from 'preact';\nimport './History.css';\nimport Helmet from 'preact-helmet';\nimport { useState, useEffect, useCallback } from 'preact/hooks';\n// Import getWatchHistory instead of getContinueWatching for actual watch history\nimport { getFullWatchHistory, deleteWatchItem, getBatchedWatchHistory } from '../utils/watchHistory';\nimport { useAuth } from '../context/Auth';\nimport { API_BASE_URL } from '../config';\nimport MovieCard from '../components/MovieCard';\nimport { useStore } from '../store';\n\n// Helper function to fetch with retry logic\nconst fetchWithRetry = async (url, maxRetries = 3, delay = 1000) => {\n    for (let i = 0; i < maxRetries; i++) {\n        try {\n            // Create a timeout promise for environments that don't support AbortSignal.timeout\n            const timeoutPromise = new Promise((_, reject) => {\n                setTimeout(() => reject(new Error('Request timeout')), 10000);\n            });\n\n            const fetchPromise = fetch(url, {\n                headers: {\n                    'Accept': 'application/json',\n                    'Content-Type': 'application/json',\n                }\n            });\n            \n            const response = await Promise.race([fetchPromise, timeoutPromise]);\n            \n            if (!response.ok) {\n                throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n            }\n            \n            return response;\n        } catch (error) {\n            console.warn(`Fetch attempt ${i + 1} failed for ${url}:`, error.message);\n            \n            if (i === maxRetries - 1) {\n                throw error;\n            }\n            \n            // Wait before retrying\n            await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));\n        }\n    }\n};\n\nconst History = () => {\n    const { user } = useAuth();\n    const [history, setHistory] = useState([]);\n    const [loading, setLoading] = useState(true);\n    const [error, setError] = useState(null);\n    const [loadingMore, setLoadingMore] = useState(false);\n    const [hasMore, setHasMore] = useState(true);\n    const { removeContinueWatchingItem, fetchContinueWatching } = useStore();\n\n    const fetchHistory = useCallback(async () => {\n        if (!user) {\n            setLoading(false);\n            return;\n        }\n        \n        setLoading(true);\n        setError(null);\n        setHistory([]);\n        setHasMore(true);\n        \n        try {\n            // Use batched loading to show results progressively\n            await loadHistoryBatch(0, true);\n        } catch (error) {\n            console.error('Error fetching watch history:', error);\n            setError('Failed to load watch history. Please try again.');\n            setHistory([]);\n        } finally {\n            setLoading(false);\n        }\n    }, [user]);\n\n    const loadHistoryBatch = useCallback(async (offset = 0, isInitial = false) => {\n        if (!user || (!isInitial && !hasMore)) return;\n        \n        if (!isInitial) setLoadingMore(true);\n        \n        try {\n            const batchSize = 20;\n            const batch = await getBatchedWatchHistory(user.id, offset, batchSize);\n            \n            if (batch.length === 0) {\n                setHasMore(false);\n                return;\n            }\n            \n            setHistory(prev => {\n                // Avoid duplicates by filtering out items that already exist\n                const existingIds = new Set(prev.map(item => item.watch_id));\n                const newItems = batch.filter(item => !existingIds.has(item.watch_id));\n                return [...prev, ...newItems];\n            });\n            \n            // If we got fewer items than requested, we've reached the end\n            if (batch.length < batchSize) {\n                setHasMore(false);\n            }\n        } catch (error) {\n            console.error('Error loading history batch:', error);\n            if (isInitial) {\n                setError('Failed to load watch history. Please try again.');\n            }\n        } finally {\n            if (!isInitial) setLoadingMore(false);\n        }\n    }, [user, hasMore]);\n\n    const loadMore = useCallback(() => {\n        if (!loadingMore && hasMore) {\n            loadHistoryBatch(history.length);\n        }\n    }, [loadHistoryBatch, history.length, loadingMore, hasMore]);\n\n    useEffect(() => {\n        fetchHistory();\n    }, [fetchHistory, user]);\n\n    const handleDelete = async (itemToDelete) => {\n        // Optimistically remove the item from the UI using the unique watch_id\n        setHistory(history.filter(item => item.watch_id !== itemToDelete.watch_id));\n        \n        // Optimistically remove from the global \"Continue Watching\" state\n        removeContinueWatchingItem(itemToDelete.media_id);\n\n        try {\n            // Call the delete function from the utils\n            await deleteWatchItem(user.id, itemToDelete);\n\n            // Refetch continue watching to ensure it's up to date\n            await fetchContinueWatching(user.id);\n        } catch (error) {\n            console.error(\"Failed to delete item or refetch continue watching:\", error);\n            // Optionally, add the item back to the history list on failure\n            // and show a toast notification to the user.\n            // For now, we'll just log the error.\n        }\n    };\n\n    const handleRetry = () => {\n        fetchHistory();\n    };\n\n    if (loading) {\n        return <div class=\"container\"><p>Loading watch history...</p></div>;\n    }\n\n    if (error) {\n        return (\n            <div class=\"container\">\n                <Helmet>\n                    <title>Watch History - Fylm</title>\n                </Helmet>\n                <h1>Watch History</h1>\n                <div class=\"error-message\">\n                    <p>{error}</p>\n                    <button onClick={handleRetry} class=\"retry-button\">Retry</button>\n                </div>\n            </div>\n        );\n    }\n\n    return (\n        <div class=\"container\">\n            <Helmet>\n                <title>Watch History - Fylm</title>\n            </Helmet>\n            <h1>Watch History</h1>\n            {history.length > 0 ? (\n                <>\n                    <div class=\"movie-grid\">\n                        {history.map(item => {\n                            return (\n                                <MovieCard \n                                    key={item.watch_id} \n                                    item={item} \n                                    type={item.type}\n                                    progress={item.progress_seconds}\n                                    duration={item.duration_seconds}\n                                    showDeleteButton={true}\n                                    onDelete={handleDelete}\n                                    useFullResolution={true}\n                                />\n                            );\n                        })}\n                    </div>\n                    {hasMore && (\n                        <div class=\"load-more-container\">\n                            <button \n                                class=\"load-more-btn\" \n                                onClick={loadMore}\n                                disabled={loadingMore}\n                            >\n                                {loadingMore ? 'Loading...' : 'Load More'}\n                            </button>\n                        </div>\n                    )}\n                </>\n            ) : (\n                !loading && <p>Your watch history is empty.</p>\n            )}\n        </div>\n    );\n};\n\nexport default History;"],"names":["History","user","useAuth","history","setHistory","useState","loading","setLoading","error","setError","loadingMore","setLoadingMore","hasMore","setHasMore","removeContinueWatchingItem","fetchContinueWatching","useStore","fetchHistory","useCallback","loadHistoryBatch","offset","isInitial","batch","getBatchedWatchHistory","prev","existingIds","item","newItems","loadMore","useEffect","handleDelete","itemToDelete","deleteWatchItem","handleRetry","jsx","jsxs","Helmet","Fragment","MovieCard"],"mappings":"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"}