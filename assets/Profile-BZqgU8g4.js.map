{"version":3,"file":"Profile-BZqgU8g4.js","sources":["../../src/pages/Profile.jsx"],"sourcesContent":["import { h } from 'preact';\nimport { useState, useRef, useEffect } from 'preact/hooks';\nimport { route } from 'preact-router';\nimport { useAuth } from '../context/Auth';\nimport { supabase } from '../supabase';\nimport toast from '../components/Toast';\nimport './Profile.css';\nimport { getProxiedImageUrl } from '../config';\n\n// Move this function above Profile so it's defined before use\nconst getAvatarUrl = (profile, user) => {\n  if (profile?.avatar_url) return getProxiedImageUrl(profile.avatar_url);\n  if (user?.user_metadata?.picture) return getProxiedImageUrl(user.user_metadata.picture);\n  if (user?.user_metadata?.avatar_url) return getProxiedImageUrl(user.user_metadata.avatar_url);\n  return '/assets/default-avatar.png';\n};\n\nconst Profile = () => {\n  const { user, profile, refreshProfile } = useAuth();\n  const [fullName, setFullName] = useState(profile?.full_name || '');\n  const [avatarUrl, setAvatarUrl] = useState(getAvatarUrl(profile, user));\n  const [avatarFile, setAvatarFile] = useState(null);\n  const [loading, setLoading] = useState(false);\n  const [initializing, setInitializing] = useState(true);\n  const fileInputRef = useRef();\n\n  useEffect(() => {\n    if (profile) {\n      setFullName(profile.full_name || '');\n      setAvatarUrl(getAvatarUrl(profile, user));\n      setInitializing(false);\n    } else if (user) {\n      setFullName(user.user_metadata?.full_name || '');\n      setAvatarUrl(getAvatarUrl(null, user));\n      setInitializing(false);\n    }\n  }, [profile, user]);\n\n  if (!user) {\n    return <div className=\"profile-container\"><div className=\"profile-form\"><h2>Not logged in</h2></div></div>;\n  }\n  if (initializing) {\n    return <div className=\"profile-container\"><div className=\"profile-form\"><h2>Loading profile...</h2></div></div>;\n  }\n\n  const handleNameChange = (e) => setFullName(e.target.value);\n\n  const handleAvatarChange = (e) => {\n    const file = e.target.files[0];\n    if (!file) return;\n    if (!file.type.startsWith('image/')) {\n      toast.error('Please select a valid image file.');\n      return;\n    }\n    if (file.size > 50 * 1024 * 1024) {\n      toast.error('Avatar must be less than 50MB.');\n      return;\n    }\n    setAvatarFile(file);\n    const reader = new FileReader();\n    reader.onload = (ev) => setAvatarUrl(ev.target.result);\n    reader.readAsDataURL(file);\n  };\n\n  const handleSave = async (e) => {\n    e.preventDefault();\n    setLoading(true);\n\n    try {\n      let newAvatarUrl = null;\n\n      // 1. If a new avatar is selected, upload it first.\n      if (avatarFile) {\n        const fileExt = avatarFile.name.split('.').pop();\n        const filePath = `avatars/${user.id}/${Date.now()}.${fileExt}`;\n\n        const { error: uploadError } = await supabase.storage\n          .from('avatars')\n          .upload(filePath, avatarFile, {\n            upsert: true,\n            cacheControl: '3600',\n          });\n\n        if (uploadError) throw uploadError;\n\n        // Get the public URL of the uploaded file.\n        const { data: urlData } = supabase.storage.from('avatars').getPublicUrl(filePath);\n        newAvatarUrl = urlData.publicUrl;\n      }\n\n      // 2. Prepare the data for the user update.\n      // We only include fields that are being changed.\n      const userUpdateData = {\n        data: {\n          full_name: fullName,\n          // Only update avatar_url if a new one was uploaded\n          ...(newAvatarUrl && { avatar_url: newAvatarUrl }),\n        },\n      };\n\n      // 3. Update the user's auth metadata.\n      // A trigger in Supabase should handle syncing this to the 'profiles' table.\n      const { data: { user: updatedUser }, error: userError } = await supabase.auth.updateUser(userUpdateData);\n\n      if (userError) throw userError;\n\n      // 4. Refresh local profile state to reflect changes immediately.\n      await refreshProfile();\n\n      toast.success('Profile updated successfully!');\n      \n      // No longer redirecting, user can see the successful change and then navigate.\n\n    } catch (err) {\n      console.error(\"Profile update failed:\", err);\n      toast.error(err.message || 'An error occurred while updating your profile.');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"profile-container\">\n      <div className=\"profile-form\" style={{ maxWidth: 420 }}>\n        <form onSubmit={handleSave}>\n            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: 24 }}>\n              <label htmlFor=\"avatar-upload\" style={{ cursor: 'pointer' }}>\n                <img\n                  src={avatarUrl}\n                  alt=\"Profile avatar\"\n                  style={{ width: 96, height: 96, borderRadius: '50%', objectFit: 'cover', marginBottom: 8, border: '2px solid var(--brand-primary)' }}\n                />\n                <input\n                  id=\"avatar-upload\"\n                  type=\"file\"\n                  accept=\"image/*\"\n                  style={{ display: 'none' }}\n                  ref={fileInputRef}\n                  onChange={handleAvatarChange}\n                  aria-label=\"Change profile picture\"\n                />\n                <div style={{ color: 'var(--brand-primary)', fontSize: 14, textAlign: 'center' }}>Change Avatar</div>\n              </label>\n            </div>\n            <div className=\"input-group\">\n              <label htmlFor=\"full-name\">Full Name</label>\n              <input\n                id=\"full-name\"\n                className=\"input-field\"\n                type=\"text\"\n                value={fullName}\n                onInput={handleNameChange}\n                placeholder=\"Your name\"\n                maxLength={40}\n                required\n              />\n            </div>\n            <div className=\"input-group\">\n              <label>Email</label>\n              <input\n                className=\"input-field\"\n                type=\"email\"\n                value={user.email}\n                disabled\n                readOnly\n              />\n            </div>\n            <button className=\"button\" type=\"submit\" disabled={loading} style={{ marginTop: 16 }}>\n              {loading ? 'Saving...' : 'Save Changes'}\n            </button>\n          </form>\n        </div>\n      </div>\n  );\n};\n\nexport default Profile;"],"names":["getAvatarUrl","profile","user","getProxiedImageUrl","Profile","refreshProfile","useAuth","fullName","setFullName","useState","avatarUrl","setAvatarUrl","avatarFile","setAvatarFile","loading","setLoading","initializing","setInitializing","fileInputRef","useRef","useEffect","jsx","jsxs","e","newAvatarUrl","fileExt","filePath","uploadError","supabase","urlData","userUpdateData","updatedUser","userError","toast","err","file","reader","ev"],"mappings":"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"}